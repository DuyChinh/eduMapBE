<%- include('../partials/header', { title: title, currentPage: 'mindmaps', user: user }) %>

<div class="mindmap-edit-page">
    <div class="page-header mb-3">
        <div class="page-actions">
            <a href="/admin/mindmaps/<%= mindmap._id %>" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Detail
            </a>
        </div>
    </div>

    <form id="editMindmapForm" onsubmit="saveMindmap(event)">
        <div class="row">
            <!-- Basic Info -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-info-circle"></i> Basic Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">ID</label>
                            <input type="text" class="form-control" value="<%= mindmap._id %>" disabled>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Title</label>
                            <input type="text" name="title" class="form-control" value="<%= mindmap.title || '' %>" placeholder="Enter mindmap title">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea name="desc" class="form-control" rows="3" placeholder="Enter description"><%= mindmap.desc || '' %></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Image URL</label>
                            <input type="text" name="img" class="form-control" value="<%= mindmap.img || '' %>" placeholder="Enter image URL">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-cog"></i> Settings</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">User</label>
                            <select name="user_id" class="form-select">
                                <option value="">No User</option>
                                <% users.forEach(u => { %>
                                    <option value="<%= u._id %>" <%= mindmap.user_id && mindmap.user_id.toString() === u._id.toString() ? 'selected' : '' %>>
                                        <%= u.name || u.email %> (<%= u.email %>)
                                    </option>
                                <% }); %>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select name="status" class="form-select">
                                <option value="true" <%= mindmap.status ? 'selected' : '' %>>Active</option>
                                <option value="false" <%= !mindmap.status ? 'selected' : '' %>>Inactive</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input type="checkbox" name="favorite" class="form-check-input" id="favoriteCheck" <%= mindmap.favorite ? 'checked' : '' %>>
                                <label class="form-check-label" for="favoriteCheck">
                                    <i class="fas fa-star text-warning"></i> Mark as Favorite
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Timestamps (read-only) -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-clock"></i> Timestamps</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Created At</label>
                            <input type="text" class="form-control" value="<%= mindmap.created_at ? <% 
    const mindmapcre = new Date(mindmap.created_at);
    const day = String(mindmapcre.getDate()).padStart(2, '0');
    const month = String(mindmapcre.getMonth() + 1).padStart(2, '0');
    const year = mindmapcre.getFullYear();
    const hours = String(mindmapcre.getHours()).padStart(2, '0');
    const minutes = String(mindmapcre.getMinutes()).padStart(2, '0');
    const seconds = String(mindmapcre.getSeconds()).padStart(2, '0');
  %><%= `${day}/${month}/${year} ${hours}:${minutes}:${seconds}` %> : 'N/A' %>" disabled>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Updated At</label>
                            <input type="text" class="form-control" value="<%= mindmap.updated_at ? <% 
    const mindmapupd = new Date(mindmap.updated_at);
    const day = String(mindmapupd.getDate()).padStart(2, '0');
    const month = String(mindmapupd.getMonth() + 1).padStart(2, '0');
    const year = mindmapupd.getFullYear();
    const hours = String(mindmapupd.getHours()).padStart(2, '0');
    const minutes = String(mindmapupd.getMinutes()).padStart(2, '0');
    const seconds = String(mindmapupd.getSeconds()).padStart(2, '0');
  %><%= `${day}/${month}/${year} ${hours}:${minutes}:${seconds}` %> : 'N/A' %>" disabled>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Save Button -->
        <div class="card">
            <div class="card-body d-flex justify-content-between">
                <button type="button" class="btn btn-danger" onclick="deleteMindmap('<%= mindmap._id %>')">
                    <i class="fas fa-trash"></i> Delete Mindmap
                </button>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </form>
</div>

<script>
    function saveMindmap(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        
        const data = {
            title: formData.get('title'),
            desc: formData.get('desc'),
            img: formData.get('img'),
            user_id: formData.get('user_id') || null,
            status: formData.get('status') === 'true',
            favorite: form.querySelector('[name="favorite"]').checked
        };

        fetch(`/v1/api/admin/mindmaps/<%= mindmap._id %>`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getToken()}`
            },
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(data => {
            if (data.ok) {
                showNotification('Mindmap updated successfully!', 'success');
                setTimeout(() => {
                    window.location.href = `/admin/mindmaps/<%= mindmap._id %>`;
                }, 800);
            } else {
                showNotification('Error: ' + data.message, 'danger');
            }
        })
        .catch(err => {
            console.error('Error:', err);
            showNotification('Error updating mindmap', 'danger');
        });
    }

    function deleteMindmap(mindmapId) {
        if (!confirm('Are you sure you want to delete this mindmap? This action cannot be undone!')) return;
        fetch(`/v1/api/admin/mindmaps/${mindmapId}?permanent=true`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${getToken()}` }
        })
        .then(res => res.json())
        .then(data => {
            if (data.ok) {
                showNotification('Mindmap deleted successfully!', 'success');
                setTimeout(() => {
                    window.location.href = '/admin/mindmaps';
                }, 800);
            } else {
                showNotification('Error: ' + data.message, 'danger');
            }
        })
        .catch(err => {
            console.error('Error:', err);
            showNotification('Error deleting mindmap', 'danger');
        });
    }

    function getToken() {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'admin_token') return value;
        }
        return '';
    }
</script>

<%- include('../partials/footer') %>
