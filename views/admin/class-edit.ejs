<%- include('../partials/header', { title: title, currentPage: 'classes', user: user }) %>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Edit Class</h2>
        <a href="/admin/classes" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Classes
        </a>
    </div>

    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Class Information</h5>
        </div>
        <div class="card-body">
            <form id="editClassForm" onsubmit="saveClass(event)">
                <input type="hidden" id="editClassId" value="<%= classDoc._id %>">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" id="editClassName" class="form-control" value="<%= classDoc.name || '' %>" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Code</label>
                        <input type="text" id="editClassCode" class="form-control" value="<%= classDoc.code || '' %>" required>
                        <small class="text-muted">Class code must be unique</small>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Organization</label>
                        <select id="editClassOrgId" class="form-select">
                            <option value="">No Organization</option>
                            <% if (organizations && organizations.length > 0) { %>
                                <% organizations.forEach(org => { %>
                                    <% 
                                        const currentOrgId = classDoc.orgId ? (classDoc.orgId._id ? classDoc.orgId._id.toString() : classDoc.orgId.toString()) : '';
                                        const orgId = org._id.toString();
                                        const isSelected = currentOrgId === orgId;
                                    %>
                                    <option value="<%= org._id %>" <%= isSelected ? 'selected' : '' %>>
                                        <%= org.name %> <% if (org.domain) { %>(<%= org.domain %>)<% } %>
                                    </option>
                                <% }); %>
                            <% } %>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Teacher</label>
                        <select id="editClassTeacherId" class="form-select" required>
                            <option value="">Select Teacher</option>
                            <% if (teachers && teachers.length > 0) { %>
                                <% teachers.forEach(teacher => { %>
                                    <% 
                                        const currentTeacherId = classDoc.teacherId ? (classDoc.teacherId._id ? classDoc.teacherId._id.toString() : classDoc.teacherId.toString()) : '';
                                        const teacherId = teacher._id.toString();
                                        const isSelected = currentTeacherId === teacherId;
                                    %>
                                    <option value="<%= teacher._id %>" <%= isSelected ? 'selected' : '' %>>
                                        <%= teacher.name %> (<%= teacher.email %>) - <%= teacher.role %>
                                    </option>
                                <% }); %>
                            <% } %>
                        </select>
                    </div>
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Students</label>
                        <select id="editClassStudentIds" class="form-select" multiple size="10">
                            <% if (students && students.length > 0) { %>
                                <% students.forEach(student => { %>
                                    <% 
                                        const currentStudentIds = classDoc.studentIds || [];
                                        const studentIdStr = student._id.toString();
                                        const isSelected = currentStudentIds.some(s => {
                                            const sId = s._id ? s._id.toString() : s.toString();
                                            return sId === studentIdStr;
                                        });
                                    %>
                                    <option value="<%= student._id %>" <%= isSelected ? 'selected' : '' %>>
                                        <%= student.name %> (<%= student.email %>)
                                    </option>
                                <% }); %>
                            <% } %>
                        </select>
                        <small class="text-muted">Hold Ctrl (or Cmd on Mac) to select multiple students</small>
                    </div>
                </div>

                <hr>

                <h5 class="mb-3">Settings</h5>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editClassAllowLateSubmission" 
                                <%= classDoc.settings && classDoc.settings.allowLateSubmission ? 'checked' : '' %>>
                            <label class="form-check-label" for="editClassAllowLateSubmission">
                                Allow Late Submission
                            </label>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Max Attempts</label>
                        <input type="number" id="editClassMaxAttempts" class="form-control" 
                            value="<%= classDoc.settings && classDoc.settings.maxAttempts ? classDoc.settings.maxAttempts : 1 %>" 
                            min="1" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editClassProctoringEnabled" 
                                <%= classDoc.settings && classDoc.settings.proctoringEnabled ? 'checked' : '' %>>
                            <label class="form-check-label" for="editClassProctoringEnabled">
                                Proctoring Enabled
                            </label>
                        </div>
                    </div>
                </div>

                <hr>

                <h5 class="mb-3">Metadata</h5>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Subject</label>
                        <input type="text" id="editClassSubject" class="form-control" 
                            value="<%= classDoc.metadata && classDoc.metadata.subject ? classDoc.metadata.subject : '' %>">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Semester</label>
                        <input type="text" id="editClassSemester" class="form-control" 
                            value="<%= classDoc.metadata && classDoc.metadata.semester ? classDoc.metadata.semester : '' %>">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Academic Year</label>
                        <input type="text" id="editClassAcademicYear" class="form-control" 
                            value="<%= classDoc.metadata && classDoc.metadata.academicYear ? classDoc.metadata.academicYear : '' %>">
                    </div>
                </div>

                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                    <a href="/admin/classes" class="btn btn-secondary">
                        Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function saveClass(e) {
        e.preventDefault();
        const classId = document.getElementById('editClassId').value;
        const formData = {
            name: document.getElementById('editClassName').value,
            code: document.getElementById('editClassCode').value.toUpperCase(),
            teacherId: document.getElementById('editClassTeacherId').value
        };

        // Organization (optional, can be null)
        const orgId = document.getElementById('editClassOrgId').value;
        formData.orgId = orgId && orgId.trim() !== '' ? orgId : null;

        // Students (multiple select)
        const studentSelect = document.getElementById('editClassStudentIds');
        const selectedStudents = Array.from(studentSelect.selectedOptions).map(option => option.value);
        formData.studentIds = selectedStudents;

        // Settings
        formData.settings = {
            allowLateSubmission: document.getElementById('editClassAllowLateSubmission').checked,
            maxAttempts: parseInt(document.getElementById('editClassMaxAttempts').value),
            proctoringEnabled: document.getElementById('editClassProctoringEnabled').checked
        };

        // Metadata
        const subject = document.getElementById('editClassSubject').value;
        const semester = document.getElementById('editClassSemester').value;
        const academicYear = document.getElementById('editClassAcademicYear').value;
        
        if (subject || semester || academicYear) {
            formData.metadata = {};
            if (subject) formData.metadata.subject = subject;
            if (semester) formData.metadata.semester = semester;
            if (academicYear) formData.metadata.academicYear = academicYear;
        }

        fetch(`/v1/api/admin/classes/${classId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getToken()}`
            },
            body: JSON.stringify(formData)
        })
        .then(res => {
            if (!res.ok) {
                return res.json().then(err => Promise.reject(err));
            }
            return res.json();
        })
        .then(data => {
            if (data.ok) {
                showNotification('Class updated successfully!', 'success');
                setTimeout(() => {
                    window.location.href = '/admin/classes';
                }, 800);
            } else {
                showNotification('Error: ' + (data.message || 'Unknown error'), 'danger');
            }
        })
        .catch(err => {
            console.error('Error updating class:', err);
            showNotification('Error: ' + (err.message || 'Failed to update class. Please check console for details.'), 'danger');
        });
    }

    function getToken() {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'admin_token') return value;
        }
        return '';
    }
</script>

<%- include('../partials/footer') %>

