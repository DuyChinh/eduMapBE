<%- include('../partials/header', { title: title || 'Payments Management',
currentPage: 'payments', user: user }) %>

<div class="payments-container p-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-money-bill-wave me-2"></i> Payments Management</h2>
  </div>

  <!-- Filters -->
  <div class="card mb-4">
    <div class="card-body">
      <form action="/admin/payments" method="GET" class="row g-3">
        <div class="col-md-4">
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input
              type="text"
              class="form-control"
              name="search"
              placeholder="Search TxnRef, Order Info..."
              value="<%= typeof pagination !== 'undefined' && pagination.search ? pagination.search : '' %>"
            />
          </div>
        </div>
        <div class="col-md-3">
          <select class="form-select" name="status">
            <option value="">All Statuses</option>
            <option value="SUCCESS">Success</option>
            <option value="PENDING">Pending</option>
            <option value="FAILED">Failed</option>
          </select>
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary w-100">Filter</button>
        </div>
        <div class="col-md-2">
          <a href="/admin/payments" class="btn btn-outline-secondary w-100"
            >Reset</a
          >
        </div>
      </form>
    </div>
  </div>

  <!-- Payments Table -->
  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Date</th>
              <th>User</th>
              <th>Amount</th>
              <th>Order Info</th>
              <th>TxnRef</th>
              <th>VNP Info</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <% if (payments && payments.length > 0) { %> <%
            payments.forEach(payment => { %>
            <tr>
              <td>
                <%= new Date(payment.createdAt).toLocaleDateString('vi-VN') %>
                <br />
                <small class="text-muted"
                  ><%= new Date(payment.createdAt).toLocaleTimeString('vi-VN')
                  %></small
                >
              </td>
              <td>
                <% if (payment.userId) { %>
                <div class="d-flex align-items-center">
                  <div class="ms-2">
                    <div class="fw-bold">
                      <%= payment.userId.name || 'Unknown' %>
                    </div>
                    <div class="small text-muted">
                      <%= payment.userId.email %>
                    </div>
                  </div>
                </div>
                <% } else { %>
                <span class="text-muted">Anonymous</span>
                <% } %>
              </td>
              <td class="fw-bold text-success">
                <%= new Intl.NumberFormat('vi-VN', { style: 'currency',
                currency: payment.currency || 'VND' }).format(payment.amount) %>
              </td>
              <td><%= payment.orderInfo %></td>
              <td><code><%= payment.txnRef %></code></td>
              <td>
                <% if (payment.vnpTransactionNo) { %>
                <small>
                  <strong>TranNo:</strong> <%= payment.vnpTransactionNo %><br />
                  <strong>Bank:</strong> <%= payment.vnpBankCode %><br />
                  <strong>Card:</strong> <%= payment.vnpCardType %>
                </small>
                <% } else { %>
                <span class="text-muted">-</span>
                <% } %>
              </td>
              <td>
                <% if (payment.status === 'SUCCESS') { %>
                <span class="badge bg-success">Success</span>
                <% } else if (payment.status === 'PENDING') { %>
                <span class="badge bg-warning text-dark">Pending</span>
                <% } else { %>
                <span class="badge bg-danger">Failed</span>
                <% if (payment.statusDescription) { %>
                <br /><small class="text-danger" style="font-size: 0.75rem"
                  ><%= payment.statusDescription %></small
                >
                <% } %> <% } %>
              </td>
            </tr>
            <% }); %> <% } else { %>
            <tr>
              <td colspan="7" class="text-center py-5">
                <div class="text-muted">
                  <i class="fas fa-inbox fa-3x mb-3"></i>
                  <p>No payment transactions found.</p>
                </div>
              </td>
            </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Pagination -->
    <% if (pagination && pagination.pages > 1) { %>
    <div
      class="card-footer bg-white d-flex justify-content-between align-items-center"
    >
      <small class="text-muted">
        Showing <%= (pagination.page - 1) * pagination.limit + 1 %> to <%=
        Math.min(pagination.page * pagination.limit, pagination.total) %> of <%=
        pagination.total %> entries
      </small>
      <nav>
        <ul class="pagination mb-0">
          <li class="page-item <%= pagination.page === 1 ? 'disabled' : '' %>">
            <a
              class="page-link"
              href="/admin/payments?page=<%= pagination.page - 1 %>&status=<%= typeof status !== 'undefined' ? status : '' %>&search=<%= typeof search !== 'undefined' ? search : '' %>"
              >Previous</a
            >
          </li>

          <% for(let i = 1; i <= pagination.pages; i++) { %>
          <li class="page-item <%= pagination.page === i ? 'active' : '' %>">
            <a
              class="page-link"
              href="/admin/payments?page=<%= i %>&status=<%= typeof status !== 'undefined' ? status : '' %>&search=<%= typeof search !== 'undefined' ? search : '' %>"
              ><%= i %></a
            >
          </li>
          <% } %>

          <li
            class="page-item <%= pagination.page === pagination.pages ? 'disabled' : '' %>"
          >
            <a
              class="page-link"
              href="/admin/payments?page=<%= pagination.page + 1 %>&status=<%= typeof status !== 'undefined' ? status : '' %>&search=<%= typeof search !== 'undefined' ? search : '' %>"
              >Next</a
            >
          </li>
        </ul>
      </nav>
    </div>
    <% } %>
  </div>
</div>

<%- include('../partials/footer') %>
