<%- include('../partials/header') %>

    <div class="container-fluid">
        <div class="row mb-4">
            <div class="col-12 d-flex justify-content-between align-items-center">
                <h2 class="mb-0">System Audit Logs</h2>
                <div class="d-flex align-items-center">
                    <span id="connection-status" class="badge bg-secondary me-3">Connecting...</span>
                    <button class="btn btn-outline-primary btn-sm" onclick="location.reload()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h6 class="card-title">Total Logs</h6>
                        <h3 class="mb-0">
                            <%= pagination.total %>
                        </h3>
                    </div>
                </div>
            </div>
            <div class="col-md-9">
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Realtime monitoring is active. New actions will appear here automatically.
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <form method="GET" action="/admin/audit-logs" class="row g-3">
                    <div class="col-md-2">
                        <label class="form-label small text-muted">Action</label>
                        <select name="action" class="form-select form-select-sm">
                            <option value="">All Actions</option>
                            <option value="CREATE" <% if (filters.action==='CREATE' ) { %>selected<% } %>>CREATE
                            </option>
                            <option value="UPDATE" <% if (filters.action==='UPDATE' ) { %>selected<% } %>>UPDATE
                            </option>
                            <option value="DELETE" <% if (filters.action==='DELETE' ) { %>selected<% } %>>DELETE
                            </option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-muted">Collection</label>
                        <select name="collection" class="form-select form-select-sm">
                            <option value="">All Collections</option>
                            <option value="users" <% if (filters.collection === 'users') { %>selected<% } %>>users</option>
                            <option value="classes" <% if (filters.collection === 'classes') { %>selected<% } %>>classes</option>
                            <option value="questions" <% if (filters.collection === 'questions') { %>selected<% } %>>questions</option>
                            <option value="submissions" <% if (filters.collection === 'submissions') { %>selected<% } %>>submissions</option>
                            <option value="exams" <% if (filters.collection === 'exams') { %>selected<% } %>>exams</option>
                            <% for (var i=0; i < collections.length; i++) { %>
                                <% if (!['users', 'classes', 'questions', 'submissions', 'exams'].includes(collections[i])) { %>
                                <option value="<%= collections[i] %>" <% if (filters.collection===collections[i]) { %>
                                    selected<% } %>><%= collections[i] %>
                                </option>
                                <% } %>
                            <% } %>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-muted">Start Date</label>
                        <input type="date" name="startDate" class="form-control form-control-sm"
                            value="<%= filters.startDate %>">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-muted">End Date</label>
                        <input type="date" name="endDate" class="form-control form-control-sm"
                            value="<%= filters.endDate %>">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-muted">Performed By</label>
                        <input type="text" name="performedBy" class="form-control form-control-sm"
                            placeholder="Email..." value="<%= filters.performedBy %>">
                    </div>
                    <div class="col-md-2 d-flex align-items-end gap-2">
                        <button type="submit" class="btn btn-primary btn-sm">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                        <a href="/admin/audit-logs" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-times"></i> Clear
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Logs Table -->
        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="audit-table">
                        <thead class="bg-light">
                            <tr>
                                <th>Time</th>
                                <th>Action</th>
                                <th>Collection</th>
                                <th>Document ID</th>
                                <th>Performed By</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="audit-table-body">
                            <% if (logs && logs.length> 0) { %>
                                <% for (var i=0; i < logs.length; i++) { %>
                                    <% var log=logs[i]; %>
                                        <% var colors=['#3498db', '#e74c3c' , '#2ecc71' , '#9b59b6' , '#f39c12'
                                            , '#1abc9c' , '#34495e' , '#e91e63' ]; var email=(log.performedBy &&
                                            log.performedBy.email) ? log.performedBy.email : '' ; var colorIndex=email ?
                                            email.charCodeAt(0) % colors.length : 0; var avatarColor=colors[colorIndex];
                                            var avatarLetter=email ? email.charAt(0).toUpperCase() : 'S' ; var
                                            userAvatar=(log.performedBy && log.performedBy.userId &&
                                            log.performedBy.userId.profile && log.performedBy.userId.profile.avatar) ?
                                            log.performedBy.userId.profile.avatar : null; var badgeClass='bg-secondary'
                                            ; if (log.action==='CREATE' ) badgeClass='bg-success' ; if
                                            (log.action==='UPDATE' ) badgeClass='bg-warning text-dark' ; if
                                            (log.action==='DELETE' ) badgeClass='bg-danger' ; %>
                                            <tr class="audit-row">
                                                <td class="text-muted">
                                                    <small>
                                                        <% 
                                                            const logtimesta = new Date(log.timestamp);
                                                            const day = String(logtimesta.getDate()).padStart(2, '0');
                                                            const month = String(logtimesta.getMonth() + 1).padStart(2, '0');
                                                            const year = logtimesta.getFullYear();
                                                            const hours = String(logtimesta.getHours()).padStart(2, '0');
                                                            const minutes = String(logtimesta.getMinutes()).padStart(2, '0');
                                                            const seconds = String(logtimesta.getSeconds()).padStart(2, '0');
                                                        %>
                                                        <%= `${day}/${month}/${year} ${hours}:${minutes}:${seconds}` %>
                                                    </small>
                                                </td>
                                                <td>
                                                    <span class="badge <%= badgeClass %>">
                                                        <%= log.action %>
                                                    </span>
                                                </td>
                                                <td class="fw-bold">
                                                    <%= log.collectionName %>
                                                </td>
                                                <td>
                                                    <code class="text-primary"><%= log.documentId %></code>
                                                </td>
                                                <td>
                                                    <% if (log.performedBy && log.performedBy.email &&
                                                        log.performedBy.email !=='System / ChangeStream' ) { %>
                                                        <div class="d-flex align-items-center">
                                                            <% if (userAvatar) { %>
                                                                <img src="<%= userAvatar %>" alt="Avatar" class="me-2"
                                                                    style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                                                                <% } else { %>
                                                                    <div class="me-2"
                                                                        style="background-color: <%= avatarColor %>; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">
                                                                        <%= avatarLetter %>
                                                                    </div>
                                                                    <% } %>
                                                                        <div>
                                                                            <div class="fw-bold"
                                                                                style="font-size: 13px;">
                                                                                <%= log.performedBy.email %>
                                                                            </div>
                                                                            <small class="text-muted">
                                                                                <%= log.performedBy.role %>
                                                                            </small>
                                                                        </div>
                                                        </div>
                                                        <% } else { %>
                                                            <div class="d-flex align-items-center">
                                                                <div class="me-2"
                                                                    style="background-color: #95a5a6; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                                                                    <i class="fas fa-robot"
                                                                        style="font-size: 14px;"></i>
                                                                </div>
                                                                <span class="text-muted">System</span>
                                                            </div>
                                                            <% } %>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-light view-data-btn" type="button"
                                                        data-index="<%= i %>">
                                                        View Data
                                                    </button>
                                                </td>
                                            </tr>
                                            <% } %>
                                                <% } else { %>
                                                    <tr id="no-logs-row">
                                                        <td colspan="6" class="text-center py-5 text-muted">
                                                            <i class="fas fa-history fa-3x mb-3"></i>
                                                            <p>No audit logs found.</p>
                                                        </td>
                                                    </tr>
                                                    <% } %>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination -->
            <% if (pagination.pages> 1) { %>
                <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                    <small class="text-muted">Showing page <%= pagination.page %> of <%= pagination.pages %></small>
                    <nav>
                        <ul class="pagination mb-0">
                            <% if (pagination.page> 1) { %>
                                <li class="page-item">
                                    <a class="page-link"
                                        href="?page=<%= pagination.page - 1 %>&action=<%= filters.action %>&collection=<%= filters.collection %>&startDate=<%= filters.startDate %>&endDate=<%= filters.endDate %>&performedBy=<%= filters.performedBy %>">Previous</a>
                                </li>
                                <% } %>
                                    <% for (var p=1; p <=pagination.pages; p++) { %>
                                        <% if (p===1 || p===pagination.pages || (p>= pagination.page - 2 && p <=
                                                pagination.page + 2)) { %>
                                                <li class="page-item <% if (pagination.page === p) { %>active<% } %>">
                                                    <a class="page-link"
                                                        href="?page=<%= p %>&action=<%= filters.action %>&collection=<%= filters.collection %>&startDate=<%= filters.startDate %>&endDate=<%= filters.endDate %>&performedBy=<%= filters.performedBy %>">
                                                        <%= p %>
                                                    </a>
                                                </li>
                                                <% } else if (p===2 || p===pagination.pages - 1) { %>
                                                    <li class="page-item disabled"><span class="page-link">...</span>
                                                    </li>
                                                    <% } %>
                                                        <% } %>
                                                            <% if (pagination.page < pagination.pages) { %>
                                                                <li class="page-item">
                                                                    <a class="page-link"
                                                                        href="?page=<%= pagination.page + 1 %>&action=<%= filters.action %>&collection=<%= filters.collection %>&startDate=<%= filters.startDate %>&endDate=<%= filters.endDate %>&performedBy=<%= filters.performedBy %>">Next</a>
                                                                </li>
                                                                <% } %>
                        </ul>
                    </nav>
                </div>
                <% } %>
        </div>
    </div>

    <!-- Detail Modal - Must be outside main container -->
    <div class="modal fade" id="logDetailModal" tabindex="-1" aria-labelledby="logDetailModalLabel" aria-hidden="true"
        data-bs-backdrop="true" data-bs-keyboard="true">
        <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered" style="max-width: 95vw; width: 95vw;">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title" id="logDetailModalLabel">
                        <i class="fas fa-file-alt me-2 text-primary"></i>Audit Log Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="logDetailContent">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .animate-pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .highlight-new {
            animation: highlight 2s ease-out;
        }

        @keyframes highlight {
            from {
                background-color: #d4edda;
            }

            to {
                background-color: transparent;
            }
        }

        /* Fix modal z-index issues */
        #logDetailModal {
            z-index: 1055 !important;
        }

        .modal-backdrop {
            z-index: 1050 !important;
        }

        /* Prevent horizontal scroll in modal */
        #logDetailModal .modal-body {
            overflow-x: hidden;
        }

        #logDetailModal pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-all;
            overflow-x: hidden;
        }

        #logDetailModal code {
            word-break: break-all;
        }
    </style>

    <!-- Store logs data as JSON in a hidden element -->
    <script id="logsDataScript" type="application/json"><%- JSON.stringify(logs) %></script>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Socket.io connection for realtime updates
        const socket = io();
        let isConnected = false;

        socket.on('connect', function() {
            isConnected = true;
            document.getElementById('connection-status').className = 'badge bg-success me-3';
            document.getElementById('connection-status').textContent = 'Connected';
        });

        socket.on('disconnect', function() {
            isConnected = false;
            document.getElementById('connection-status').className = 'badge bg-danger me-3';
            document.getElementById('connection-status').textContent = 'Disconnected';
        });

        // Listen for db_change events and refresh the page
        socket.on('db_change', function(data) {
            // Only refresh if it's an auditlogs change or add a notification
            if (data.collectionName === 'auditlogs') {
                // Auto-refresh the page to show new audit logs
                location.reload();
            } else {
                // Show a notification that new activity occurred
                const statusBadge = document.getElementById('connection-status');
                statusBadge.className = 'badge bg-warning me-3 animate-pulse';
                statusBadge.textContent = 'New Activity - Click Refresh';
            }
        });
    </script>

    <%- include('../partials/footer') %>